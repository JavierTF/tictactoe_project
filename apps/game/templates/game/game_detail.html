{% extends 'base.html' %}

{% block title %}Game {{ game_id }} - TicTacToe{% endblock %}

{% block content %}
<div x-data="gameApp()" x-init="init()" x-cloak>
    <!-- Back button -->
    <div class="mb-6">
        <a href="/" class="text-blue-600 hover:text-blue-800">
            ‚Üê Back to Games
        </a>
    </div>

    <!-- Loading state -->
    <div x-show="loading" class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        <p class="mt-4 text-gray-600">Loading game...</p>
    </div>

    <!-- Error state -->
    <div x-show="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        <span x-text="error"></span>
    </div>

    <!-- Game content -->
    <div x-show="!loading && game" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left sidebar: Game info -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">Game Info</h2>

                <!-- Status -->
                <div class="mb-4">
                    <span 
                        :class="{
                            'bg-orange-100 text-orange-800': game.status === 'waiting',
                            'bg-blue-100 text-blue-800': game.status === 'in_progress',
                            'bg-green-100 text-green-800': game.status === 'finished',
                            'bg-gray-100 text-gray-800': game.status === 'draw'
                        }"
                        class="px-3 py-1 rounded-full text-sm font-semibold"
                        x-text="getStatusText(game.status)"
                    ></span>
                </div>

                <!-- Players -->
                <div class="space-y-3 mb-6">
                    <div class="flex items-center justify-between p-3 rounded"
                         :class="game.current_turn === 'X' ? 'bg-blue-50 border-2 border-blue-500' : 'bg-gray-50'">
                        <div>
                            <div class="text-sm text-gray-600">Player 1</div>
                            <div class="font-semibold symbol-x" x-text="game.player1?.username"></div>
                        </div>
                        <div class="text-2xl font-bold symbol-x">X</div>
                    </div>

                    <div class="flex items-center justify-between p-3 rounded"
                         :class="game.current_turn === 'O' ? 'bg-orange-50 border-2 border-orange-500' : 'bg-gray-50'">
                        <div>
                            <div class="text-sm text-gray-600">Player 2</div>
                            <div class="font-semibold" 
                                 :class="game.player2 ? 'symbol-o' : 'text-gray-400'"
                                 x-text="game.player2?.username || 'Waiting...'">
                            </div>
                        </div>
                        <div class="text-2xl font-bold symbol-o">O</div>
                    </div>
                </div>

                <!-- Current turn indicator -->
                <div x-show="game.status === 'in_progress'" class="mb-4">
                    <div class="bg-blue-50 border border-blue-200 rounded p-3">
                        <div class="text-sm text-gray-600 mb-1">Current Turn</div>
                        <div class="flex items-center space-x-2">
                            <span class="text-2xl font-bold"
                                  :class="game.current_turn === 'X' ? 'symbol-x' : 'symbol-o'"
                                  x-text="game.current_turn">
                            </span>
                            <span class="text-sm" x-text="getCurrentPlayerName()"></span>
                        </div>
                        <div x-show="game.is_my_turn" class="mt-2 text-sm font-semibold text-green-600">
                            üéØ Your turn!
                        </div>
                        <div x-show="!game.is_my_turn && game.player2" class="mt-2 text-sm text-gray-600">
                            ‚è≥ Waiting for opponent...
                        </div>
                    </div>
                </div>

                <!-- Winner announcement -->
                <div x-show="game.status === 'finished'" class="mb-4">
                    <div class="bg-yellow-100 border border-yellow-400 rounded p-4 text-center">
                        <div class="text-2xl mb-2">üèÜ</div>
                        <div class="font-bold text-lg" x-text="'Winner: ' + game.winner"></div>
                    </div>
                </div>

                <!-- Draw announcement -->
                <div x-show="game.status === 'draw'" class="mb-4">
                    <div class="bg-gray-100 border border-gray-400 rounded p-4 text-center">
                        <div class="text-2xl mb-2">ü§ù</div>
                        <div class="font-bold text-lg">It's a Draw!</div>
                    </div>
                </div>

                <!-- Connection status -->
                <div class="text-sm">
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 rounded-full"
                             :class="wsConnected ? 'bg-green-500' : 'bg-red-500'">
                        </div>
                        <span x-text="wsConnected ? 'Connected' : 'Disconnected'"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center: Game board -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-6 text-center">TicTacToe Board</h2>

                <!-- Waiting for player2 message -->
                <div x-show="game.status === 'waiting'" 
                     class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-6 text-center">
                    <p class="text-yellow-800">‚è≥ Waiting for another player to join...</p>
                    <p class="text-sm text-yellow-600 mt-2">Share this URL with a friend!</p>
                </div>

                <!-- Game board -->
                <div class="grid grid-cols-3 gap-3 max-w-md mx-auto">
                    <template x-for="(cell, index) in game.board" :key="index">
                        <button
                            @click="makeMove(index)"
                            :disabled="!canMakeMove(index)"
                            :class="{
                                'occupied': cell !== null,
                                'cursor-pointer hover:bg-gray-100': canMakeMove(index),
                                'cursor-not-allowed bg-gray-50': !canMakeMove(index)
                            }"
                            class="board-cell bg-white border-2 border-gray-300 rounded-lg flex items-center justify-center text-4xl font-bold h-24"
                        >
                            <span 
                                :class="{
                                    'symbol-x': cell === 'X',
                                    'symbol-o': cell === 'O'
                                }"
                                x-text="cell || ''"
                            ></span>
                        </button>
                    </template>
                </div>

                <!-- Move history -->
                <div x-show="game.moves && game.moves.length > 0" class="mt-8">
                    <h3 class="text-lg font-bold mb-3">Move History</h3>
                    <div class="max-h-48 overflow-y-auto space-y-2">
                        <template x-for="(move, index) in game.moves" :key="move.id">
                            <div class="flex items-center space-x-3 text-sm bg-gray-50 p-2 rounded">
                                <span class="text-gray-500" x-text="'#' + (index + 1)"></span>
                                <span class="font-semibold" x-text="move.player.username"></span>
                                <span 
                                    :class="move.symbol === 'X' ? 'symbol-x' : 'symbol-o'"
                                    class="font-bold"
                                    x-text="move.symbol"
                                ></span>
                                <span class="text-gray-500">‚Üí Position</span>
                                <span class="font-semibold" x-text="move.position"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function gameApp() {
        return {
            game: null,
            loading: true,
            error: null,
            ws: null,
            wsConnected: false,
            gameId: '{{ game_id }}',
            currentUser: '{{ user.username }}',

            async init() {
                await this.loadGame();
                this.connectWebSocket();
            },

            async loadGame() {
                this.loading = true;
                this.error = null;

                try {
                    const response = await fetch(`/api/v1/games/${this.gameId}/`, {
                        credentials: 'include'
                    });

                    if (!response.ok) throw new Error('Failed to load game');

                    this.game = await response.json();
                } catch (err) {
                    this.error = err.message;
                } finally {
                    this.loading = false;
                }
            },

            connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/game/${this.gameId}/`;

                this.ws = new WebSocket(wsUrl);

                this.ws.onopen = () => {
                    console.log('WebSocket connected');
                    this.wsConnected = true;
                };

                this.ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    this.wsConnected = false;

                    // Reconnect after 3 seconds
                    setTimeout(() => {
                        if (!this.wsConnected) {
                            this.connectWebSocket();
                        }
                    }, 3000);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.error = 'Connection error';
                };

                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                };
            },

            handleWebSocketMessage(data) {
                console.log('WebSocket message:', data);

                if (data.type === 'game_state' || data.type === 'game_update') {
                    this.game = data.data;
                } else if (data.type === 'error') {
                    this.error = data.message;
                }
            },

            async makeMove(position) {
                if (!this.canMakeMove(position)) return;

                // Clear any previous errors
                this.error = null;

                // Send move via WebSocket
                if (this.ws && this.wsConnected) {
                    this.ws.send(JSON.stringify({
                        type: 'move',
                        position: position
                    }));
                } else {
                    this.error = 'Not connected to game server';
                }
            },

            canMakeMove(position) {
                if (!this.game) return false;
                if (this.game.status !== 'in_progress') return false;
                if (!this.game.is_my_turn) return false;
                if (this.game.board[position] !== null) return false;
                return true;
            },

            getCurrentPlayerName() {
                if (!this.game) return '';
                if (this.game.current_turn === 'X') {
                    return this.game.player1?.username || '';
                } else {
                    return this.game.player2?.username || '';
                }
            },

            getStatusText(status) {
                const statusMap = {
                    'waiting': 'Waiting for Players',
                    'in_progress': 'In Progress',
                    'finished': 'Finished',
                    'draw': 'Draw'
                };
                return statusMap[status] || status;
            }
        }
    }
</script>
{% endblock %}